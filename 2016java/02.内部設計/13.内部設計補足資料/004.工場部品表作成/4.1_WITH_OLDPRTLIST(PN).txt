,OLDPRT /* 旧部品番号 */
(
	PRTNO,
	REVNO,
	OLDPRTNO,
	RNK
) AS
(
	SELECT distinct
		OLDPRT.PARTS_NO AS PRTNO,
		OLDPRT.ENGINEERING_PN_REV_NO AS REVNO,
		OLDPRT.PREV_PARTS_NO AS OLDPRTNO,																				/* 旧部品番号 */
		RANK() OVER(PARTITION BY OLDPRT.PARTS_NO, OLDPRT.ENGINEERING_PN_REV_NO ORDER BY OLDPRT.PREV_PARTS_NO) AS RNK
	FROM
		TB001006 OLDPRT						/* 旧部品 */
	WHERE
		EXISTS								/* 展開部品一覧に存在 */
		(
			SELECT
				*
			FROM
				TEMP
			WHERE
				TEMP.PRTNO=OLDPRT.PARTS_NO
		)
),
OLDPRTLIST
(
	PRTNO,			/* 対象部品番号 */
	REVNO,			/* 技術部品改訂番号 */
	OLDPRTNOLIST,	/* 旧部品番号をカンマ区切りしたもの */
	RNK,
	ISLEAF
) AS
(
	SELECT
		OLD.PRTNO,
		OLD.REVNO,
		OLD.OLDPRTNO AS OLDPRTNOLIST,
		OLD.RNK,
		CASE WHEN 
			(
				SELECT 
					COUNT(*) 
				FROM 
					OLDPRT OLD2
				WHERE 
					OLD2.PRTNO=OLD.PRTNO AND
					OLD2.REVNO=OLD.REVNO AND
					OLD2.RNK-1=OLD.RNK
			) > 0 
		THEN 0 ELSE 1 END AS ISLEAF
	FROM
		OLDPRT OLD
	WHERE
		OLD.RNK=1
	UNION ALL
	SELECT
		OLD.PRTNO,
		OLD.REVNO,
		(OLDL.OLDPRTNOLIST || ',' || OLD.OLDPRTNO) AS OLDPRTNOLIST,
		OLD.RNK,
		CASE WHEN 
			(
				SELECT 
					COUNT(*) 
				FROM 
					OLDPRT OLD2
				WHERE 
					OLD2.PRTNO=OLD.PRTNO AND
					OLD2.REVNO=OLD.REVNO AND
					OLD2.RNK-1=OLD.RNK
			) > 0 
		THEN 0 ELSE 1 END AS ISLEAF
	FROM
		OLDPRT OLD,
		OLDPRTLIST OLDL
	WHERE
		OLD.PRTNO=OLDL.PRTNO AND
		OLD.REVNO=OLDL.REVNO AND
		OLD.RNK-1=OLDL.RNK
)
