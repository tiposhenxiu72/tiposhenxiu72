,OLDPRT /* 旧部品番号 */
(
	PARPRTNO,
	PRTNO,
	REVNO,
	OLDPRTNO,
	RNK
) AS
(
	SELECT distinct
		OLDSTRC.PARENT_PARTS_NO AS PARPRTNO,
		OLDSTRC.SUB_PARTS_NO AS PRTNO,
		OLDSTRC.ENGINEERING_PS_REV_NO AS REVNO,
		OLDSTRC.PREV_SUB_PARTS_NO AS OLDPRTNO,																				/* 部品取引先コード */
		RANK() OVER(PARTITION BY OLDSTRC.PARENT_PARTS_NO, OLDSTRC.SUB_PARTS_NO, OLDSTRC.ENGINEERING_PS_REV_NO ORDER BY OLDSTRC.PREV_SUB_PARTS_NO) AS RNK
	FROM
		TB001007 OLDSTRC					/* 旧構成 */
	WHERE
		EXISTS								/* 展開構成一覧に存在 */
		(
			SELECT
				*
			FROM
				TEMP
			WHERE
				TEMP.PRTNO=OLDSTRC.PARENT_PARTS_NO AND
				TEMP.PARPRTNO=OLDSTRC.SUB_PARTS_NO
		)
),
OLDPRTLIST
(
	PARPRTNO,		/* 対象親部品番号 */
	PRTNO,			/* 対象部品番号 */
	REVNO,			/* 技術構成改訂番号 */
	OLDPRTNOLIST,	/* 旧部品番号をカンマ区切りしたもの */
	RNK,
	ISLEAF
) AS
(
	SELECT
		OLD.PARPRTNO,
		OLD.PRTNO,
		OLD.REVNO,
		OLD.OLDPRTNO AS OLDPRTNOLIST,
		OLD.RNK,
		CASE WHEN 
			(
				SELECT 
					COUNT(*) 
				FROM 
					OLDPRT OLD2
				WHERE 
					OLD2.PARPRTNO=OLD.PARPRTNO AND
					OLD2.PRTNO=OLD.PRTNO AND
					OLD2.REVNO=OLD.REVNO AND
					OLD2.RNK-1=OLD.RNK
			) > 0 
		THEN 0 ELSE 1 END AS ISLEAF
	FROM
		OLDPRT OLD
	WHERE
		OLD.RNK=1
	UNION ALL
	SELECT
		OLD.PARPRTNO,
		OLD.PRTNO,
		OLD.REVNO,
		(OLDL.OLDPRTNOLIST || ',' || OLD.OLDPRTNO) AS OLDPRTNOLIST,
		OLD.RNK,
		CASE WHEN 
			(
				SELECT 
					COUNT(*) 
				FROM 
					OLDPRT OLD2
				WHERE 
					OLD2.PARPRTNO=OLD.PARPRTNO AND
					OLD2.PRTNO=OLD.PRTNO AND
					OLD2.REVNO=OLD.REVNO AND
					OLD2.RNK-1=OLD.RNK
			) > 0 
		THEN 0 ELSE 1 END AS ISLEAF
	FROM
		OLDPRT OLD,
		OLDPRTLIST OLDL
	WHERE
		OLD.PARPRTNO=OLDL.PARPRTNO AND
		OLD.PRTNO=OLDL.PRTNO AND
		OLD.REVNO=OLDL.REVNO AND
		OLD.RNK-1=OLDL.RNK
)
