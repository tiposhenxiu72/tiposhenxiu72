,RESULT
(
	PARTS_NO,
	ENGINEERING_PN_REV_NO,
	FACTORY_PN_REV_NO,
	FACTORY_PN_STATUS,
	APPROVED_DATE,
	APPROVER_USER_ID,
	EDITOR_USER_ID,
	ADOPT_DATE,
	ABOLISH_DATE,
	TMP_REGIST_DATE,
	PENDING_DECIDED_DATE,
	JOB_SEQ_NO,
	SUPPLIER_CODE,
	PROD_BASE_CODE,
	DATA_CHECK_RESULT,
	REPR_OF_MAIN_ECS_NO,
	SKIP_FLAG,
	CANCEL_FLAG,
	PARTS_PROP_REV_NO,
	TMP_ABOLISH_DATE,
	TMP_CANCEL_FLAG,
	REMARKS,
	CREATED_USER_ID,
	CREATED_APP_EVENT_ID,
	CREATED_TIMESTAMP,
	UPDATED_USER_ID,
	UPDATED_APP_EVENT_ID,
	UPDATED_TIMESTAMP
) AS
(
	SELECT
		PARTS_NO,
		ENGINEERING_PN_REV_NO,
		FACTORY_PN_REV_NO,
		FACTORY_PN_STATUS,
		APPROVED_DATE,
		APPROVER_USER_ID,
		EDITOR_USER_ID,
		ADOPT_DATE,
		ABOLISH_DATE,
		TMP_REGIST_DATE,
		PENDING_DECIDED_DATE,
		JOB_SEQ_NO,
		SUPPLIER_CODE,
		PROD_BASE_CODE,
		DATA_CHECK_RESULT,
		REPR_OF_MAIN_ECS_NO,
		SKIP_FLAG,
		CANCEL_FLAG,
		PARTS_PROP_REV_NO,
		TMP_ABOLISH_DATE,
		TMP_CANCEL_FLAG,
		REMARKS,
		CREATED_USER_ID,
		CREATED_APP_EVENT_ID,
		CREATED_TIMESTAMP,
		UPDATED_USER_ID,
		UPDATED_APP_EVENT_ID,
		UPDATED_TIMESTAMP
	FROM
		(
			SELECT
				MPRT.PARTS_NO,
				MPRT.ENGINEERING_PN_REV_NO,
				MPRT.FACTORY_PN_REV_NO,
				MPRT.FACTORY_PN_STATUS,
				MPRT.APPROVED_DATE,
				MPRT.APPROVER_USER_ID,
				MPRT.EDITOR_USER_ID,
				MPRT.ADOPT_DATE,
				MPRT.ABOLISH_DATE,
				MPRT.TMP_REGIST_DATE,
				MPRT.PENDING_DECIDED_DATE,
				MPRT.JOB_SEQ_NO,
				MPRT.SUPPLIER_CODE,
				MPRT.PROD_BASE_CODE,
				MPRT.DATA_CHECK_RESULT,
				MPRT.REPR_OF_MAIN_ECS_NO,
				MPRT.SKIP_FLAG,
				MPRT.CANCEL_FLAG,
				MPRT.PARTS_PROP_REV_NO,
				MPRT.TMP_ABOLISH_DATE,
				MPRT.TMP_CANCEL_FLAG,
				MPRT.REMARKS,
				MPRT.CREATED_USER_ID,
				MPRT.CREATED_APP_EVENT_ID,
				MPRT.CREATED_TIMESTAMP,
				MPRT.UPDATED_USER_ID,
				MPRT.UPDATED_APP_EVENT_ID,
				MPRT.UPDATED_TIMESTAMP,
				DECODE(PRT.DRAWING_CLASS, 'F', MSTRCDUMMY.CONSUMPTION_ROUTING, '') AS CONSUMPTION_ROUTING,										/* 消費工順 */
				DECODE(PRT.DRAWING_CLASS, 'F', MSTRCDUMMY.PROCESSING_CODE, '') AS PROCESSING_CODE												/* 加工区分 */
			FROM
				TB004001 MPRT																													/* 工場部品情報 */
					INNER JOIN TB001003 PRT ON																									/* 部品諸元 (工場部品情報の諸元改訂番号と合致) */	
						PRT.PARTS_NO=MPRT.PARTS_NO AND
						PRT.PARTS_PROP_REV_NO=MPRT.PARTS_PROP_REV_NO
					LEFT OUTER JOIN TB004002 MSTRCDUMMY ON																						/* 工場構成情報 (ダミー親構成。部品の採用期間に対応するデータを取得。仕様上2レコード以上取得されないはず。) */
						MSTRCDUMMY.SUB_PARTS_NO=MPRT.PARTS_NO AND
						MSTRCDUMMY.PARENT_PARTS_NO='T' AND
						MSTRCDUMMY.REPR_OF_MAIN_ECS_NO=MPRT.REPR_OF_MAIN_ECS_NO
			WHERE
				EXISTS																															/* 展開した部品番号一覧に存在している部品番号 */
				(
					SELECT
						*
					FROM
						TEMP
					WHERE	
						TEMP.PRTNO=MPRT.PARTS_NO
				)
		)
	WHERE
		CANCEL_FLAG='0' AND																													/* 無効フラグが「有効」 */
		(FACTORY_PN_STATUS!=:STATUS OR ABOLISH_DATE > CAST(:TODAY AS DATE)) AND																/* ◎本登録済みではないか、または過去廃止ではないデータ */
		(FACTORY_PN_STATUS=:STATUS AND ADOPT_DATE <= CAST(:DATE AS DATE) AND ABOLISH_DATE > CAST(:DATE AS DATE)) AND						/* ◇過去履歴指定時に指定する日付条件。本登録済のみ表示する。ブランクの場合はこの条件を除外する */
		PROCESSING_CODE=:PRCS_CD AND																										/* ▼加工区分の指定 */
		CONSUMPTION_ROUTING=:CONS_RTNG AND																									/* □消費工順の指定 */
		JOB_SEQ_NO=:JOB_SEQ																													/* ◆発生工順の指定 */
UNION ALL																																		/* ◎無効フラグが「無効」のデータも取得する。マスクがOFFになった際には、UNION ALL以下のSELECT文を除外する */
	SELECT
		MPRT.PARTS_NO,
		MPRT.ENGINEERING_PN_REV_NO,
		MPRT.FACTORY_PN_REV_NO,
		MPRT.FACTORY_PN_STATUS,
		MPRT.APPROVED_DATE,
		MPRT.APPROVER_USER_ID,
		MPRT.EDITOR_USER_ID,
		MPRT.ADOPT_DATE,
		MPRT.ABOLISH_DATE,
		MPRT.TMP_REGIST_DATE,
		MPRT.PENDING_DECIDED_DATE,
		MPRT.JOB_SEQ_NO,
		MPRT.SUPPLIER_CODE,
		MPRT.PROD_BASE_CODE,
		MPRT.DATA_CHECK_RESULT,
		MPRT.REPR_OF_MAIN_ECS_NO,
		MPRT.SKIP_FLAG,
		MPRT.CANCEL_FLAG,
		MPRT.PARTS_PROP_REV_NO,
		MPRT.TMP_ABOLISH_DATE,
		MPRT.TMP_CANCEL_FLAG,
		MPRT.REMARKS,
		MPRT.CREATED_USER_ID,
		MPRT.CREATED_APP_EVENT_ID,
		MPRT.CREATED_TIMESTAMP,
		MPRT.UPDATED_USER_ID,
		MPRT.UPDATED_APP_EVENT_ID,
		MPRT.UPDATED_TIMESTAMP
	FROM
		RESULT,
		TB004001 MPRT																														/* 工場部品情報 */
	WHERE
		MPRT.PARTS_NO=RESULT.PARTS_NO AND
		MPRT.ENGINEERING_PN_REV_NO=RESULT.ENGINEERING_PN_REV_NO AND
		MPRT.FACTORY_PN_REV_NO=LTRIM(TO_CHAR(RESULT.FACTORY_PN_REV_NO - 1, '000')) AND
		MPRT.CANCEL_FLAG='1' 																												/* 無効フラグが「無効」 */
)
